<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Football Manager – Realtime</title>
<style>
  body{font-family:Arial,sans-serif;margin:0;background:#f4f4f4;color:#333}
  #login{display:flex;justify-content:center;align-items:center;height:100vh;background:rgba(0,0,0,.6)}
  #login form{background:#fff;padding:2rem;border-radius:8px;width:320px;text-align:center}
  #login input{width:100%;padding:.6rem;margin:1rem 0;border:1px solid #ccc;border-radius:4px}
  #login button{background:#28a745;color:#fff;border:none;padding:.7rem;width:100%;border-radius:4px;cursor:pointer}
  nav{background:#28a745;color:#fff;padding:1rem;text-align:center}
  nav a{color:#fff;margin:0 1rem;text-decoration:none;font-weight:bold}
  nav a.active{color:#ffd700;border-bottom:2px solid #ffd700}
  section{display:none;padding:2rem;background:#fff;margin:1rem auto;max-width:900px;border-radius:8px}
  section.active{display:block}
  table{width:100%;border-collapse:collapse;margin-top:1rem}
  th,td{border:1px solid #ddd;padding:.6rem;text-align:left}
  th{background:#28a745;color:#fff}
  #messages{height:400px;overflow-y:auto;border:1px solid #ccc;padding:.5rem;background:#fafafa}
  #messages div{margin:.4rem 0;padding:.5rem;background:#e9ecef;border-radius:4px}
  #messages img{max-width:200px;margin:.5rem 0;border-radius:4px}
</style>
</head>
<body>

<div id="login">
  <form id="loginForm">
    <h2>Connexion</h2>
    <input type="password" id="pwd" placeholder="Mot de passe">
    <button type="submit">Entrer</button>
    <p id="loginErr" style="color:red"></p>
  </form>
</div>

<div id="app" style="display:none">
  <nav>
    <a id="tab-accueil" class="active">Accueil</a>
    <a id="tab-e1">Équipe 1</a>
    <a id="tab-e2">Équipe 2</a>
    <a id="tab-chat">Chat</a>
  </nav>

  <section id="accueil" class="active">
    <h2>Date du match</h2>
    <p id="matchDate">…</p>
    <button id="editDateBtn">Modifier</button>
  </section>

  <!-- ================== EQUIPE 1 ================== -->
  <section id="e1">
    <h2>Équipe 1</h2>
    <form id="formE1">
      <input type="text" placeholder="Nom" id="nom1" required>
      <input type="text" placeholder="Prénom" id="prenom1" required>
      <input type="date" id="date1">
      <select id="pres1"><option value="present">Présent</option><option value="absent">Absent</option></select>
      <button type="submit">Ajouter</button>
    </form>
    <table id="tblE1"><thead><tr><th>Nom</th><th>Prénom</th><th>Date</th><th>Présence</th><th></th></tr></thead><tbody></tbody></table>
  </section>

  <!-- ================== EQUIPE 2 ================== -->
  <section id="e2">
    <h2>Équipe 2</h2>
    <form id="formE2">
      <input type="text" placeholder="Nom" id="nom2" required>
      <input type="text" placeholder="Prénom" id="prenom2" required>
      <input type="date" id="date2">
      <select id="pres2"><option value="present">Présent</option><option value="absent">Absent</option></select>
      <button type="submit">Ajouter</button>
    </form>
    <table id="tblE2"><thead><tr><th>Nom</th><th>Prénom</th><th>Date</th><th>Présence</th><th></th></tr></thead><tbody></tbody></table>
  </section>

  <!-- ================== CHAT ================== -->
  <section id="chat">
    <h2>Chat</h2>
    <input type="file" id="photo" accept="image/*" style="display:none">
    <button id="photoBtn">Photo</button>
    <div id="messages"></div>
    <div style="display:flex;margin-top:.5rem">
      <input type="text" id="name" placeholder="Nom" style="flex:1">
      <input type="text" id="msg" placeholder="Message" style="flex:3">
      <button id="sendBtn">Envoyer</button>
    </div>
  </section>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, set, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDDaIWa5ev6kT7GTeVhiqDgT0Ht5271wOg",
    authDomain: "matchwkw.firebaseapp.com",
    databaseURL: "https://matchwkw-default-rtdb.firebaseio.com/",
    projectId: "matchwkw",
    storageBucket: "matchwkw.firebasestorage.app",
    messagingSenderId: "423077744195",
    appId: "1:423077744195:web:89fd8a51ac193b51c88ef6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const storage = getStorage(app);
  const auth = getAuth(app);

  // ---------- ANONYMOUS LOGIN ----------
  signInAnonymously(auth).catch(err=>console.error('Auth error',err));

  // ---------- UI HELPERS ----------
  const hide = el=>el.style.display='none';
  const show = el=>el.style.display='block';
  const $ = id=>document.getElementById(id);
  const tabs = {accueil:'accueil', e1:'e1', e2:'e2', chat:'chat'};
  Object.keys(tabs).forEach(k=>$(`tab-${k}`).onclick=()=>{openTab(tabs[k])});
  function openTab(id){
    Object.values(tabs).forEach(s=>$(s).classList.remove('active'));
    Object.keys(tabs).forEach(t=>$(`tab-${t}`).classList.remove('active'));
    $(id).classList.add('active');
    $(`tab-${Object.keys(tabs).find(k=>tabs[k]===id)}`).classList.add('active');
  }

  // ---------- LOGIN ----------
  const LOGIN_PWD = 'matchwkw';
  $('loginForm').onsubmit = e=>{
    e.preventDefault();
    if($('pwd').value===LOGIN_PWD){
      hide($('login')); show($('app'));
    }else{
      $('loginErr').textContent='Mot de passe incorrect';
    }
  };

  // ---------- MATCH DATE ----------
  const dateRef = ref(db,'matchDate');
  onValue(dateRef,snap=>{$('matchDate').textContent = snap.val()||'—';});
  $('editDateBtn').onclick=()=>{
    const pwd=prompt('Mot de passe admin');
    if(pwd!==LOGIN_PWD) return alert('Incorrect');
    const d=prompt('Nouvelle date (YYYY-MM-DD)');
    if(d) set(dateRef,d);
  };

  // ---------- TEAMS ----------
  const e1Ref = ref(db,'equipe1');
  const e2Ref = ref(db,'equipe2');
  let e1Data={}, e2Data={}, editKey=null, editTeam=null;

  function render(team){
    const data = team===1?e1Data:e2Data;
    const tbody = $(`tblE${team}`).querySelector('tbody');
    tbody.innerHTML='';
    Object.entries(data).forEach(([k,v])=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${v.nom}</td><td>${v.prenom}</td><td>${v.date||''}</td>
        <td>${v.presence==='present'?'Présent':'Absent'}</td>
        <td>
          <button onclick="startEdit(${team},'${k}')">Edit</button>
          <button onclick="del(${team},'${k}')">Suppr</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }
  onValue(e1Ref,s=>{e1Data=s.val()||{}; render(1);});
  onValue(e2Ref,s=>{e2Data=s.val()||{}; render(2);});

  function startEdit(team,key){
    const obj = (team===1?e1Data:e2Data)[key];
    $(`nom${team}`).value = obj.nom;
    $(`prenom${team}`).value = obj.prenom;
    $(`date${team}`).value = obj.date||'';
    $(`pres${team}`).value = obj.presence;
    editKey=key; editTeam=team;
    $(`formE${team}`).querySelector('button').textContent='Mettre à jour';
  }
  window.startEdit=startEdit;

  function del(team,key){
    if(prompt('Mot de passe admin')!==LOGIN_PWD) return;
    remove(ref(db,`equipe${team}/${key}`));
  }
  window.del=del;

  function submitTeam(team){
    const nom=$(`nom${team}`).value.trim();
    const prenom=$(`prenom${team}`).value.trim();
    const date=$(`date${team}`).value;
    const pres=$(`pres${team}`).value;
    if(!nom||!prenom) return alert('Nom + Prénom requis');

    const payload={nom,prenom,date,presence:pres};

    if(editKey && editTeam===team){
      set(ref(db,`equipe${team}/${editKey}`),payload);
      editKey=null; editTeam=null;
      $(`formE${team}`).querySelector('button').textContent='Ajouter';
    }else{
      push(ref(db,`equipe${team}`),payload);
    }
    $(`nom${team}`).value='';$(`prenom${team}`).value='';$(`date${team}`).value='';
  }
  $('formE1').onsubmit=e=>{e.preventDefault();submitTeam(1);}
  $('formE2').onsubmit=e=>{e.preventDefault();submitTeam(2);}

  // ---------- CHAT ----------
  const msgRef = ref(db,'messages');
  const msgDiv = $('messages');

  onValue(msgRef,snap=>{
    msgDiv.innerHTML='';
    const list=[];
    snap.forEach(c=>list.push(c.val()));
    list.sort((a,b)=>a.ts-b.ts);
    list.forEach(m=>{
      if(m.type==='text'){
        const d=document.createElement('div');
        d.innerHTML=`<strong>${m.name}:</strong> ${m.content}`;
        msgDiv.appendChild(d);
      }else if(m.type==='image'){
        const i=document.createElement('img');
        i.src=m.content;
        msgDiv.appendChild(i);
      }
    });
    msgDiv.scrollTop=msgDiv.scrollHeight;
  });

  $('sendBtn').onclick=()=>{
    const name=$('name').value.trim();
    const txt=$('msg').value.trim();
    if(!name) return alert('Nom requis');
    if(txt){
      push(msgRef,{type:'text',name,content:txt,ts:serverTimestamp()});
      $('msg').value='';
    }
  };
  $('msg').addEventListener('keypress',e=>{if(e.key==='Enter') $('sendBtn').click();});

  // Photo upload
  $('photoBtn').onclick=()=>$('photo').click();
  $('photo').onchange=e=>{
    const name=$('name').value.trim();
    if(!name) return alert('Nom requis');
    const file=e.target.files[0];
    if(!file) return;
    const sref = sRef(storage,'chat/'+Date.now()+'_'+file.name);
    uploadBytes(sref,file).then(()=>getDownloadURL(sref))
      .then(url=>push(msgRef,{type:'image',name,content:url,ts:serverTimestamp()}));
  };
</script>
</body>
</html>
